@model TradeScope.Domain.Models.SettingsViewModel
@inject TradeScope.Localization.ITranslationService T

@{
    ViewData["Title"] = T["Settings"];
}


<form id="settingsForm" asp-action="Save" asp-controller="Settings" method="post" class="ts-form">
    @Html.AntiForgeryToken()
    <input type="hidden" id="SettingsJson" name="SettingsJson" />
    <section class="ts-section">
        <div class="ts-settings-actions">
            <button id="btnSaveAssetTarget" type="submit" class="ts-chip ts-chip-outline">@T["SaveLabel"]</button>
        </div>
        <div class="ts-grid-withdrawl">
            <div class="ts-card">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["CapitalAndRisk"]</span>
                </div>
                <div class="ts-card-body">
                    <div class="ts-settings-grid">
                        <div class="ts-settings-group">
                            <div class="ts-filter-field">
                                <label asp-for="InitialCapital">@T["InitialCapital"]</label>
                                <input asp-for="InitialCapital" type="number" style="width: auto;overflow:hidden;" />
                            </div>
                            <div class="ts-filter-field">
                                <label asp-for="RiskPerTradePercent">@T["RiskPerTradePercentLabel"]</label>
                                <input asp-for="RiskPerTradePercent" type="number" step="0.01" style="width: auto;overflow:hidden;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ts-card">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["Withdrawals"]</span>
                </div>
                <div class="ts-card-body">
                    <div class="ts-settings-group">
                        <div class="ts-filter-row">
                            <div class="ts-withdrwall-sections">
                                <div class="ts-filter-field">
                                    <label asp-for="Withdrawl.EstimateWithdrawalPerWeek">@T["PerWeek"]</label>
                                    <input asp-for="Withdrawl.EstimateWithdrawalPerWeek" class="ts-max-w-200" type="number" step="0.01" />
                                </div>
                                <div class="ts-filter-field">
                                    <label asp-for="Withdrawl.EstimateIncrementWithdrawalPerWeek">@T["IncrementPerWeek"]</label>
                                    <input asp-for="Withdrawl.EstimateIncrementWithdrawalPerWeek" class="ts-max-w-200" type="number" step="0.01" />
                                </div>
                            </div>
                            <div class="ts-withdrwall-sections">
                                <div class="ts-filter-field">
                                    <label asp-for="Withdrawl.EstimateWithdrawalPerMonth">@T["PerMonth"]</label>
                                    <input asp-for="Withdrawl.EstimateWithdrawalPerMonth" class="ts-max-w-200" type="number" step="0.01" />
                                </div>
                                <div class="ts-filter-field">
                                    <label asp-for="Withdrawl.EstimateIncrementWithdrawalPerMonth">@T["IncrementPerMonth"]</label>
                                    <input asp-for="Withdrawl.EstimateIncrementWithdrawalPerMonth" class="ts-max-w-200" type="number" step="0.01" />
                                </div>
                            </div>
                            <div class="ts-withdrwall-sections">
                                <div class="ts-filter-field">
                                    <label asp-for="Withdrawl.MaxWithdrawalPerMonth">@T["MaxPerMonth"]</label>
                                    <input asp-for="Withdrawl.MaxWithdrawalPerMonth" class="ts-max-w-200" type="number" step="0.01" />
                                </div>
                                <div class="ts-filter-field">
                                    <label asp-for="Withdrawl.MaxWithdrawalTotal">@T["MaxWithdrawlTotal"]</label>
                                    <input asp-for="Withdrawl.MaxWithdrawalTotal" class="ts-max-w-200" type="number" step="0.01" />
                                </div>
                            </div>

                            <div class="ts-filter-field ts-filter-field-wide">
                                <label asp-for="Withdrawl.WithdrawlFrequency">@T["Frequency"]</label>
                                <select asp-for="Withdrawl.WithdrawlFrequency"
                                        asp-items="Model.Withdrawl.WithdrawlFrequencyOptions"
                                        class="form-control">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="ts-grid-2 ts-grid-expand">
            <div class="ts-card ts-card-table">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["PointsTargets"]</span>
                    <button type="button" id="btnAddAssetTarget" class="ts-chip ts-chip-outline" aria-haspopup="dialog" aria-controls="modalAssetTarget">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="ts-card-body">
                    <div class="ts-table-scroll">
                        <span asp-validation-for="AssetTargetPoint" class="ts-field-error"></span>
                        <table class="ts-table" id="tblAssetTargets">
                            <thead>
                                <tr>
                                    <th class="ts-cell-left">#</th>
                                    <th class="ts-cell-left">@T["Name"]</th>
                                    <th class="ts-cell-left">@T["Description"]</th>
                                    <th class="text-grid-center">@T["PointsPerTrade"]</th>
                                </tr>
                            </thead>
                            <tbody class="ts-table-body">
                                @{
                                    if (Model != null && Model.AssetTargetPoint != null && Model.AssetTargetPoint.Any())
                                    {
                                        @for (var i = 0; i < Model.AssetTargetPoint.Count; i++)
                                        {
                                            <tr>
                                                <td class="ts-cell-left">
                                                    <input type="hidden" asp-for="AssetTargetPoint[i].AssetId" />
                                                    @Model.AssetTargetPoint[i].AssetId
                                                </td>
                                                <td class="ts-cell-left">
                                                    <input type="hidden" asp-for="AssetTargetPoint[i].AssetName" />
                                                    @Model.AssetTargetPoint[i].AssetName
                                                </td>
                                                <td class="ts-cell-left">
                                                    <input type="hidden" asp-for="AssetTargetPoint[i].AssetDescription" />
                                                    @Model.AssetTargetPoint[i].AssetDescription
                                                </td>
                                                <td class="text-grid-center">
                                                    <input type="hidden" asp-for="AssetTargetPoint[i].TargetPointPerTrade" />
                                                    @Model.AssetTargetPoint[i].TargetPointPerTrade
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="ts-card ts-card-table">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["TradesPerPhase"]</span>
                    <button type="button" id="btnAddPhaseTrade" class="ts-chip ts-chip-outline" aria-haspopup="dialog" aria-controls="modalPhaseTrade">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="ts-card-body">
                    <div class="ts-table-scroll">
                        <span asp-validation-for="StrategyPhaseTrade" class="ts-field-error"></span>
                        <table class="ts-table" id="tblPhaseTrades">
                            <thead>
                                <tr>
                                    <th class="ts-cell-left">#</th>
                                    <th class="ts-cell-left">@T["Description"]</th>
                                    <th class="text-grid-center">@T["MaxPrefix"] @T["TradesPerDay"]</th>
                                    <th class="text-grid-center">@T["MaxPrefix"] @T["TradesPerWeek"]</th>
                                    <th class="text-grid-center">@T["MaxPrefix"] @T["TradesPerMonth"]</th>
                                </tr>
                            </thead>
                            <tbody class="ts-table-body">
                                @{
                                    if (Model != null && Model.StrategyPhaseTrade != null && Model.StrategyPhaseTrade.Any())
                                    {
                                        @for (var i = 0; i < Model.StrategyPhaseTrade.Count; i++)
                                        {
                                            <tr>
                                                <td class="ts-cell-left">
                                                    <input type="hidden" asp-for="StrategyPhaseTrade[i].StrategyNumber" />
                                                    @Model.StrategyPhaseTrade[i].StrategyNumber
                                                </td>
                                                <td class="ts-cell-left">
                                                    <input type="hidden" asp-for="StrategyPhaseTrade[i].StrategyDescription" />
                                                    @Model.StrategyPhaseTrade[i].StrategyDescription
                                                </td>
                                                <td class="text-grid-center">
                                                    <input type="hidden" asp-for="StrategyPhaseTrade[i].MaxTradesPerDay" />
                                                    @Model.StrategyPhaseTrade[i].MaxTradesPerDay
                                                </td>
                                                <td class="text-grid-center">
                                                    <input type="hidden" asp-for="StrategyPhaseTrade[i].MaxTradesPerWeek" />
                                                    @Model.StrategyPhaseTrade[i].MaxTradesPerWeek
                                                </td>
                                                <td class="text-grid-center">
                                                    <input type="hidden" asp-for="StrategyPhaseTrade[i].MaxTradesPerMonth" />
                                                    @Model.StrategyPhaseTrade[i].MaxTradesPerMonth
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Hidden inputs generated from the current tables (ModelBinding) -->
    <div id="hiddenAssetTargets" class="ts-hidden"></div>
    <div id="hiddenPhaseTrades" class="ts-hidden"></div>
</form>


<!-- MODAL: Asset Target Points -->
<div class="ts-modal" id="modalAssetTarget" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalAssetTargetTitle">
    <div class="ts-modal-backdrop" data-modal-close="modalAssetTarget"></div>
    <div class="ts-modal-panel" role="document">
        <div class="ts-card ts-modal-card">
            <div class="ts-card-header">
                <div>
                    <div class="ts-card-title" id="modalAssetTargetTitle">@T["PointsTargets"]</div>
                </div>
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalAssetTarget" aria-label="Close">✕</button>
            </div>
            <div class="ts-card-body">
                <div class="ts-settings-grid">
                    <input type="hidden" id="assetId" />
                    <div class="ts-filter-field">
                        <label>@T["Name"]</label>
                        <input type="text" id="assetName" maxlength="64" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["Description"]</label>
                        <input type="text" id="assetDescription" maxlength="128" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["PointsPerTrade"]</label>
                        <input type="number" id="targetPointPerTrade" min="0" />
                    </div>
                </div>
                <div class="ts-modal-hint" id="assetTargetError" aria-live="polite"></div>
            </div>
            <div class="ts-card-footer ts-modal-footer">
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalAssetTarget">@T["CancelLabel"]</button>
                <button type="button" class="ts-chip ts-chip-primary" id="btnModalSaveAssetTarget">@T["SaveLabel"]</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Strategy Phase Trade -->
<div class="ts-modal" id="modalPhaseTrade" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalPhaseTradeTitle">
    <div class="ts-modal-backdrop" data-modal-close="modalPhaseTrade"></div>
    <div class="ts-modal-panel" role="document">
        <div class="ts-card ts-modal-card">
            <div class="ts-card-header">
                <div>
                    <div class="ts-card-title" id="modalPhaseTradeTitle">@T["TradesPerPhase"]</div>
                </div>
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalPhaseTrade" aria-label="Close">✕</button>
            </div>
            <div class="ts-card-body">
                <div class="ts-settings-grid">
                    <input type="hidden" id="strategyNumber" />
                    <div class="ts-filter-field">
                        <label>@T["Description"]</label>
                        <input type="text" id="strategyDescription" maxlength="96" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["MaxPrefix"] @T["TradesPerDay"]</label>
                        <input type="number" id="maxTradesPerDay" min="0" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["MaxPrefix"] @T["TradesPerWeek"]</label>
                        <input type="number" id="maxTradesPerWeek" min="0" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["MaxPrefix"] @T["TradesPerMonth"]</label>
                        <input type="number" id="maxTradesPerMonth" min="0" />
                    </div>
                </div>
                <div class="ts-modal-hint" id="phaseTradeError" aria-live="polite"></div>
            </div>
            <div class="ts-card-footer ts-modal-footer">
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalPhaseTrade">@T["CancelLabel"]</button>
                <button type="button" class="ts-chip ts-chip-primary" id="btnModalSavePhaseTrade">@T["SaveLabel"]</button>
            </div>
        </div>
    </div>
</div>

<script>
    "use strict";

    (function () {
        function clearListError(fieldName) {
            const span = document.querySelector(`[data-valmsg-for="${fieldName}"]`);
            if (!span) return;
            span.textContent = '';
            span.classList.remove('field-validation-error');
            span.classList.add('field-validation-valid');
        }

        function shakeInvalidFields() {
            const invalid = Array.from(document.querySelectorAll('.input-validation-error'));

            // remove/reaplica para permitir “replay” da animação
            invalid.forEach(el => {
                el.classList.remove('ts-shake');
                // força reflow
                void el.offsetWidth;
                el.classList.add('ts-shake');
            });

            // opcional: focar o primeiro inválido
            if (invalid?.length && invalid.length > 0) invalid[0].focus({ preventScroll: false });
            return invalid?.length > 0;
        }

        // Helpers (vanilla)
        const qs = (sel, root) => (root || document).querySelector(sel);
        const qsa = (sel, root) => Array.from((root || document).querySelectorAll(sel));

        const modalOpen = (id) => {
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.add('ts-modal-open');
            modal.setAttribute('aria-hidden', 'false');
            const first = modal.querySelector('input,select,textarea,button');
            if (first) first.focus();
        };

        const modalClose = (id) => {
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.remove('ts-modal-open');
            modal.setAttribute('aria-hidden', 'true');
            const err = modal.querySelector('.ts-modal-hint');
            if (err) err.textContent = '';
        };

        // Close handlers (backdrop + buttons)
        document.addEventListener('click', (e) => {
            const target = e.target;
            const closeId = target?.getAttribute?.('data-modal-close');
            if (closeId) {
                e.preventDefault();
                modalClose(closeId);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;
            const open = document.querySelector('.ts-modal.ts-modal-open');
            if (open) modalClose(open.id);
        });

        const parseIntSafe = (v) => {
            const n = parseInt(String(v ?? '').trim(), 10);
            return Number.isFinite(n) ? n : null;
        };

        const parseDecimalSafe = (v) => {
            const s = String(v ?? '').trim().replace(',', '.');
            const n = Number(s);
            return Number.isFinite(n) ? n : null;
        };

        const upsertRow = (tableId, key, cells) => {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tbody = table.tBodies[0] || table.appendChild(document.createElement('tbody'));
            const existing = Array.from(tbody.querySelectorAll('tr'))
                .find(r => (r.getAttribute('data-key') || '') === String(key));

            const tr = existing || document.createElement('tr');
            tr.setAttribute('data-key', String(key));
            tr.innerHTML = '';

            cells.forEach((c) => {
                const td = document.createElement('td');
                td.className = c.className || '';
                td.textContent = c.text;
                tr.appendChild(td);
            });

            if (!existing) tbody.appendChild(tr);
        };

        const escapeHtmlAttr = (s) => String(s ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;');

        const getAssetTargetPoints = () => {
            const table = document.getElementById('tblAssetTargets');
            const tbody = table?.tBodies?.[0];
            if (!tbody) return [];

            return Array.from(tbody.querySelectorAll('tr')).map((r) => {
                const tds = r.querySelectorAll('td');
                return {
                    AssetId: parseIntSafe(tds[0]?.textContent) ?? 0,
                    AssetName: (tds[1]?.textContent || '').trim(),
                    AssetDescription: (tds[2]?.textContent || '').trim(),
                    TargetPointPerTrade: parseIntSafe(tds[3]?.textContent) ?? 0
                };
            }).filter(x => x.AssetId > 0);
        };

        const getPhaseTrades = () => {
            const table = document.getElementById('tblPhaseTrades');
            const tbody = table?.tBodies?.[0];
            if (!tbody) return [];

            return Array.from(tbody.querySelectorAll('tr')).map((r) => {
                const tds = r.querySelectorAll('td');
                return {
                    StrategyNumber: parseIntSafe(tds[0]?.textContent) ?? 0,
                    StrategyDescription: (tds[1]?.textContent || '').trim(),
                    MaxTradesPerDay: parseIntSafe(tds[2]?.textContent) ?? 0,
                    MaxTradesPerWeek: parseIntSafe(tds[3]?.textContent) ?? 0,
                    MaxTradesPerMonth: parseIntSafe(tds[4]?.textContent) ?? 0
                };
            }).filter(x => x.StrategyNumber > 0);
        };

        const rebuildHiddenInputs = () => {
            const assetHost = document.getElementById('hiddenAssetTargets');
            const phaseHost = document.getElementById('hiddenPhaseTrades');
            if (!assetHost || !phaseHost) return;

            assetHost.innerHTML = '';
            phaseHost.innerHTML = '';

            const assetData = getAssetTargetPoints();
            assetData.forEach((x, i) => {
                assetHost.insertAdjacentHTML('beforeend', `
        <input type="hidden" name="AssetTargetPoint[${i}].AssetId" value="${x.AssetId}">
        <input type="hidden" name="AssetTargetPoint[${i}].AssetName" value="${escapeHtmlAttr(x.AssetName)}">
        <input type="hidden" name="AssetTargetPoint[${i}].AssetDescription" value="${escapeHtmlAttr(x.AssetDescription)}">
        <input type="hidden" name="AssetTargetPoint[${i}].TargetPointPerTrade" value="${x.TargetPointPerTrade}">
      `);
            });

            const phaseData = getPhaseTrades();
            phaseData.forEach((x, i) => {
                phaseHost.insertAdjacentHTML('beforeend', `
        <input type="hidden" name="StrategyPhaseTrade[${i}].StrategyNumber" value="${x.StrategyNumber}">
        <input type="hidden" name="StrategyPhaseTrade[${i}].StrategyDescription" value="${escapeHtmlAttr(x.StrategyDescription)}">
        <input type="hidden" name="StrategyPhaseTrade[${i}].MaxTradesPerDay" value="${x.MaxTradesPerDay}">
        <input type="hidden" name="StrategyPhaseTrade[${i}].MaxTradesPerWeek" value="${x.MaxTradesPerWeek}">
        <input type="hidden" name="StrategyPhaseTrade[${i}].MaxTradesPerMonth" value="${x.MaxTradesPerMonth}">
      `);
            });
        };

        // Exposed: returns a JS object matching SettingsViewModel
        window.buildSettingsModel = function () {
            const initialCapital = parseDecimalSafe(qs('input[name="InitialCapital"]')?.value) ?? 0;
            const riskPerTradePercent = Number(String(qs('input[name="RiskPerTradePercent"]')?.value ?? '0').replace(',', '.'));

            const withdrawl = {
                EstimateWithdrawalPerWeek: parseDecimalSafe(qs('input[name="Withdrawl.EstimateWithdrawalPerWeek"]')?.value) ?? 0,
                EstimateIncrementWithdrawalPerWeek: parseDecimalSafe(qs('input[name="Withdrawl.EstimateIncrementWithdrawalPerWeek"]')?.value) ?? 0,
                EstimateWithdrawalPerMonth: parseDecimalSafe(qs('input[name="Withdrawl.EstimateWithdrawalPerMonth"]')?.value) ?? 0,
                EstimateIncrementWithdrawalPerMonth: parseDecimalSafe(qs('input[name="Withdrawl.EstimateIncrementWithdrawalPerMonth"]')?.value) ?? 0,
                MaxWithdrawalPerMonth: parseDecimalSafe(qs('input[name="Withdrawl.MaxWithdrawalPerMonth"]')?.value) ?? 0,
                WithdrawlFrequency: (qs('input[name="Withdrawl.WithdrawlFrequency"]')?.value || '').trim()
            };

            return {
                InitialCapital: initialCapital,
                RiskPerTradePercent: Number.isFinite(riskPerTradePercent) ? riskPerTradePercent : 0,
                StrategyPhaseTrade: getPhaseTrades(),
                AssetTargetPoint: getAssetTargetPoints(),
                Withdrawl: withdrawl
            };
        };

        // + buttons helpers
        const getNextAssetId = () => {
            const items = getAssetTargetPoints();
            const maxId = items.reduce((acc, x) => Math.max(acc, x.AssetId || 0), 0);
            return maxId + 1;
        };

        const getNextStrategyNumber = () => {
            const items = getPhaseTrades();
            const maxId = items.reduce((acc, x) => Math.max(acc, x.StrategyNumber || 0), 0);
            return maxId + 1;
        };

        // + buttons
        qs('#btnAddAssetTarget')?.addEventListener('click', () => {
            const nextId = getNextAssetId();
            const assetIdEl = qs('#assetId');
            if (assetIdEl) assetIdEl.value = String(nextId);

            qs('#assetName').value = '';
            qs('#assetDescription').value = '';
            qs('#targetPointPerTrade').value = '';

            modalOpen('modalAssetTarget');
        });

        qs('#btnAddPhaseTrade')?.addEventListener('click', () => {
            const nextId = getNextStrategyNumber();
            const el = qs('#strategyNumber');
            if (el) el.value = String(nextId);

            qs('#strategyDescription').value = '';
            qs('#maxTradesPerDay').value = '';
            qs('#maxTradesPerWeek').value = '';
            qs('#maxTradesPerMonth').value = '';

            modalOpen('modalPhaseTrade');
        });

        // Modal save: Asset Target
        qs('#btnModalSaveAssetTarget')?.addEventListener('click', () => {
            const err = qs('#assetTargetError');
            if (err) err.textContent = '';

            const assetId = parseIntSafe(qs('#assetId')?.value);
            const assetName = (qs('#assetName')?.value || '').trim();
            const assetDescription = (qs('#assetDescription')?.value || '').trim();
            const points = parseIntSafe(qs('#targetPointPerTrade')?.value);

            if (!assetId || assetId <= 0) return (err.textContent = 'Invalid #');
            if (!assetName) return (err.textContent = 'Name is required');
            if (points == null || points < 0) return (err.textContent = 'Points is required');

            upsertRow('tblAssetTargets', assetId, [
                { className: 'ts-cell-left', text: String(assetId) },
                { className: 'ts-cell-left', text: assetName },
                { className: 'ts-cell-left', text: assetDescription },
                { className: 'text-grid-center', text: String(points) }
            ]);

            rebuildHiddenInputs();
            setTimeout(() => {
                modelChanged = shakeInvalidFields();
                clearListError("AssetTargetPoint");
                modalClose('modalAssetTarget');
            }, 0);
        });

        // Modal save: Phase Trade
        qs('#btnModalSavePhaseTrade')?.addEventListener('click', () => {
            const err = qs('#phaseTradeError');
            if (err) err.textContent = '';

            const strategyNumber = parseIntSafe(qs('#strategyNumber')?.value);
            const strategyDescription = (qs('#strategyDescription')?.value || '').trim();
            const d = parseIntSafe(qs('#maxTradesPerDay')?.value);
            const w = parseIntSafe(qs('#maxTradesPerWeek')?.value);
            const m = parseIntSafe(qs('#maxTradesPerMonth')?.value);

            if (!strategyNumber || strategyNumber <= 0) return (err.textContent = 'Invalid #');
            if (!strategyDescription) return (err.textContent = 'Description is required');
            if (d == null || d < 0 || w == null || w < 0 || m == null || m < 0) {
                return (err.textContent = 'All max fields are required');
            }

            upsertRow('tblPhaseTrades', strategyNumber, [
                { className: 'ts-cell-left', text: String(strategyNumber) },
                { className: 'ts-cell-left', text: strategyDescription },
                { className: 'text-grid-center', text: String(d) },
                { className: 'text-grid-center', text: String(w) },
                { className: 'text-grid-center', text: String(m) }
            ]);

            rebuildHiddenInputs();
            setTimeout(() => {
                modelChanged = shakeInvalidFields();
                clearListError("StrategyPhaseTrade");
                modalClose('modalPhaseTrade');
            }, 0);
        });

        // On submit: populate SettingsJson + keep hidden arrays in sync
        qs('#settingsForm')?.addEventListener('submit', () => {
            // pequeno delay para dar tempo do unobtrusive aplicar classes
            setTimeout(() => {
                rebuildHiddenInputs();
                if (!shakeInvalidFields()) return;
                const model = window.buildSettingsModel();
                qs('#SettingsJson').value = JSON.stringify(model);
            }, 0);
        });

        // First render: create hidden inputs for existing rows
        rebuildHiddenInputs();
    })();
</script>
@model TradeScope.Domain.Models.SettingsViewModel
@inject TradeScope.Localization.ITranslationService T

@{
    ViewData["Title"] = T["Settings"];
}


<div class="view-form">
    <section class="ts-section">
        <div class="ts-settings-actions">
            <button type="button" class="ts-chip ts-chip-outline">@T["SaveLabel"]</button>
        </div>
        <div class="ts-grid-2">
            <div class="ts-card">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["CapitalAndRisk"]</span>
                </div>
                <div class="ts-card-body">
                    <div class="ts-settings-grid">
                        <div class="ts-settings-group">
                            <div class="ts-filter-row">
                                <div class="ts-filter-field">
                                    <label>@T["InitialCapital"]</label>
                                    <input type="number" value="@Model.InitialCapital" />
                                </div>
                                <div class="ts-filter-field">
                                    <label>@T["RiskPerTradePercentLabel"]</label>
                                    <input type="number" step="0.01" value="@Model.RiskPerTradePercent" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ts-card">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["Withdrawals"]</span>
                </div>
                <div class="ts-card-body">
                    <div class="ts-settings-group">
                        <div class="ts-filter-row">
                            <div class="ts-filter-field">
                                <label>@T["PerWeek"]</label>
                                <input class="ts-max-w-200" type="number" step="0.01" value="@Model.Withdrawl.EstimateWithdrawalPerWeek" />
                            </div>
                            <div class="ts-filter-field">
                                <label>@T["IncrementPerWeek"]</label>
                                <input class="ts-max-w-200" type="number" step="0.01" value="@Model.Withdrawl.EstimateIncrementWithdrawalPerWeek" />
                            </div>
                            <div class="ts-filter-field">
                                <label>@T["PerMonth"]</label>
                                <input class="ts-max-w-200" type="number" step="0.01" value="@Model.Withdrawl.EstimateWithdrawalPerMonth" />
                            </div>
                            <div class="ts-filter-field">
                                <label>@T["IncrementPerMonth"]</label>
                                <input class="ts-max-w-200" type="number" step="0.01" value="@Model.Withdrawl.EstimateIncrementWithdrawalPerMonth" />
                            </div>
                            <div class="ts-filter-field">
                                <label>@T["MaxPerMonth"]</label>
                                <input class="ts-max-w-200" type="number" step="0.01" value="@Model.Withdrawl.MaxWithdrawalPerMonth" />
                            </div>
                            <div class="ts-filter-field">
                                <label>@T["Frequency"]</label>
                                <input class="ts-max-w-200" type="text" value="@Model.Withdrawl.WithdrawlFrequency.ToString()" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="ts-grid-2">
            <div class="ts-card ts-card-table">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["PointsTargets"]</span>
                    <button type="button" id="btnAddAssetTarget" class="ts-chip ts-chip-outline" aria-haspopup="dialog" aria-controls="modalAssetTarget">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="ts-card-body">
                    <table class="ts-table">
                        <thead>
                            <tr>
                                <th class="ts-cell-left">#</th>
                                <th class="ts-cell-left">@T["Name"]</th>
                                <th class="ts-cell-left">@T["Description"]</th>
                                <th class="text-grid-center">@T["PointsPerTrade"]</th>
                            </tr>
                        </thead>
                        <tbody style="overflow-y:scroll;">
                            @{
                                if (Model.StrategyPhaseTrade.Any())
                                {
                                    foreach (var item in Model.AssetTargetPoint)
                                    {
                                        <tr>
                                            <td class="ts-cell-left">@item.AssetId </td>
                                            <td class="ts-cell-left">@item.AssetName</td>
                                            <td class="ts-cell-left">@item.AssetDescription</td>
                                            <td class="text-grid-center">@item.TargetPointPerTrade</td>
                                        </tr>
                                    }
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="ts-card ts-card-table">
                <div class="ts-card-header">
                    <span class="ts-card-title">@T["TradesPerPhase"]</span>
                    <button type="button" id="btnAddPhaseTrade" class="ts-chip ts-chip-outline" aria-haspopup="dialog" aria-controls="modalPhaseTrade">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="ts-card-body">
                    <table class="ts-table">
                        <thead>
                            <tr>
                                <th class="ts-cell-left">#</th>
                                <th class="ts-cell-left">@T["Description"]</th>
                                <th class="text-grid-center">@T["MaxPrefix"] @T["TradesPerDay"]</th>
                                <th class="text-grid-center">@T["MaxPrefix"] @T["TradesPerWeek"]</th>
                                <th class="text-grid-center">@T["MaxPrefix"] @T["TradesPerMonth"]</th>
                            </tr>
                        </thead>
                        <tbody style="overflow-y:scroll;">
                            @{
                                if (Model.StrategyPhaseTrade.Any())
                                {
                                    foreach (var item in Model.StrategyPhaseTrade)
                                    {
                                        <tr>
                                            <td class="ts-cell-left">@item.StrategyNumber </td>
                                            <td class="ts-cell-left">@item.StrategyDescription</td>
                                            <td class="text-grid-center">@item.MaxTradesPerDay</td>
                                            <td class="text-grid-center">@item.MaxTradesPerWeek</td>
                                            <td class="text-grid-center">@item.MaxTradesPerMonth</td>
                                        </tr>
                                    }
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>


<!-- Hidden inputs generated from the current tables (ModelBinding) -->
<div id="hiddenAssetTargets" class="ts-hidden"></div>
<div id="hiddenPhaseTrades" class="ts-hidden"></div>

<!-- MODAL: Asset Target Points -->
<div class="ts-modal" id="modalAssetTarget" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalAssetTargetTitle">
    <div class="ts-modal-backdrop" data-modal-close="modalAssetTarget"></div>
    <div class="ts-modal-panel" role="document">
        <div class="ts-card ts-modal-card">
            <div class="ts-card-header">
                <div>
                    <div class="ts-card-title" id="modalAssetTargetTitle">@T["PointsTargets"]</div>
                  </div>
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalAssetTarget" aria-label="Close">✕</button>
            </div>
            <div class="ts-card-body">
                <div class="ts-settings-grid">
                    <div class="ts-filter-field">
                        <label>@T["Name"]</label>
                        <input type="text" id="assetName" maxlength="64" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["Description"]</label>
                        <input type="text" id="assetDescription" maxlength="128" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["PointsPerTrade"]</label>
                        <input type="number" id="targetPointPerTrade" min="0" />
                    </div>
                </div>
                <div class="ts-modal-hint" id="assetTargetError" aria-live="polite"></div>
            </div>
            <div class="ts-card-footer ts-modal-footer">
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalAssetTarget">@T["CancelLabel"]</button>
                <button type="button" class="ts-chip ts-chip-primary" id="btnModalSaveAssetTarget">@T["SaveLabel"]</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Strategy Phase Trade -->
<div class="ts-modal" id="modalPhaseTrade" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalPhaseTradeTitle">
    <div class="ts-modal-backdrop" data-modal-close="modalPhaseTrade"></div>
    <div class="ts-modal-panel" role="document">
        <div class="ts-card ts-modal-card">
            <div class="ts-card-header">
                <div>
                    <div class="ts-card-title" id="modalPhaseTradeTitle">@T["TradesPerPhase"]</div>
                </div>
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalPhaseTrade" aria-label="Close">✕</button>
            </div>
            <div class="ts-card-body">
                <div class="ts-settings-grid">
                    <div class="ts-filter-field">
                        <label>@T["Description"]</label>
                        <input type="text" id="strategyDescription" maxlength="96" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["MaxPrefix"] @T["TradesPerDay"]</label>
                        <input type="number" id="maxTradesPerDay" min="0" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["MaxPrefix"] @T["TradesPerWeek"]</label>
                        <input type="number" id="maxTradesPerWeek" min="0" />
                    </div>
                    <div class="ts-filter-field">
                        <label>@T["MaxPrefix"] @T["TradesPerMonth"]</label>
                        <input type="number" id="maxTradesPerMonth" min="0" />
                    </div>
                </div>
                <div class="ts-modal-hint" id="phaseTradeError" aria-live="polite"></div>
            </div>
            <div class="ts-card-footer ts-modal-footer">
                <button type="button" class="ts-chip ts-chip-outline" data-modal-close="modalPhaseTrade">@T["CancelLabel"]</button>
                <button type="button" class="ts-chip ts-chip-primary" id="btnModalSavePhaseTrade">@T["SaveLabel"]</button>
            </div>
        </div>
    </div>
</div>


<script>
    (function () {
        const $ = (sel, root) => (root || document).querySelector(sel);
        const $$ = (sel, root) => Array.from((root || document).querySelectorAll(sel));

        const modalOpen = (id) => {
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.add('ts-modal-open');
            modal.setAttribute('aria-hidden', 'false');
            // focus first input
            const first = modal.querySelector('input,select,textarea,button');
            if (first) first.focus();
        };

        const modalClose = (id) => {
            const modal = document.getElementById(id);
            if (!modal) return;
            modal.classList.remove('ts-modal-open');
            modal.setAttribute('aria-hidden', 'true');
            // clear errors
            const err = modal.querySelector('.ts-modal-hint');
            if (err) err.textContent = '';
        };

        // Close handlers (backdrop + buttons)
        document.addEventListener('click', (e) => {
            const target = e.target;
            const closeId = target?.getAttribute?.('data-modal-close');
            if (closeId) {
                e.preventDefault();
                modalClose(closeId);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;
            const open = document.querySelector('.ts-modal.ts-modal-open');
            if (open) modalClose(open.id);
        });

        // + buttons
        $('#btnAddAssetTarget')?.addEventListener('click', () => modalOpen('modalAssetTarget'));
        $('#btnAddPhaseTrade')?.addEventListener('click', () => modalOpen('modalPhaseTrade'));

        const parseIntSafe = (v) => {
            const n = parseInt(String(v ?? '').trim(), 10);
            return Number.isFinite(n) ? n : null;
        };
        const parseDecimalSafe = (v) => {
            const s = String(v ?? '').trim().replace(',', '.');
            const n = Number(s);
            return Number.isFinite(n) ? n : null;
        };

        const assetRows = () => $$('#tblAssetTargets tbody tr');
        const phaseRows = () => $$('#tblPhaseTrades tbody tr');

        const upsertRow = (tableId, key, cells) => {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tbody = table.tBodies[0] || table.appendChild(document.createElement('tbody'));
            const existing = Array.from(tbody.querySelectorAll('tr')).find(r => (r.getAttribute('data-key') || '') === String(key));
            const tr = existing || document.createElement('tr');
            tr.setAttribute('data-key', String(key));
            tr.innerHTML = '';
            cells.forEach((c) => {
                const td = document.createElement('td');
                td.className = c.className || '';
                td.textContent = c.text;
                tr.appendChild(td);
            });
            if (!existing) tbody.appendChild(tr);
        };

        const rebuildHiddenInputs = () => {
            const assetHost = document.getElementById('hiddenAssetTargets');
            const phaseHost = document.getElementById('hiddenPhaseTrades');
            if (!assetHost || !phaseHost) return;
            assetHost.innerHTML = '';
            phaseHost.innerHTML = '';

            const assetData = getAssetTargetPoints();
            assetData.forEach((x, i) => {
                assetHost.insertAdjacentHTML('beforeend', `
                    <input type="hidden" name="AssetTargetPoint[${i}].AssetId" value="${x.AssetId}">
                    <input type="hidden" name="AssetTargetPoint[${i}].AssetName" value="${escapeHtmlAttr(x.AssetName)}">
                    <input type="hidden" name="AssetTargetPoint[${i}].AssetDescription" value="${escapeHtmlAttr(x.AssetDescription)}">
                    <input type="hidden" name="AssetTargetPoint[${i}].TargetPointPerTrade" value="${x.TargetPointPerTrade}">
                `);
            });

            const phaseData = getPhaseTrades();
            phaseData.forEach((x, i) => {
                phaseHost.insertAdjacentHTML('beforeend', `
                    <input type="hidden" name="StrategyPhaseTrade[${i}].StrategyNumber" value="${x.StrategyNumber}">
                    <input type="hidden" name="StrategyPhaseTrade[${i}].StrategyDescription" value="${escapeHtmlAttr(x.StrategyDescription)}">
                    <input type="hidden" name="StrategyPhaseTrade[${i}].MaxTradesPerDay" value="${x.MaxTradesPerDay}">
                    <input type="hidden" name="StrategyPhaseTrade[${i}].MaxTradesPerWeek" value="${x.MaxTradesPerWeek}">
                    <input type="hidden" name="StrategyPhaseTrade[${i}].MaxTradesPerMonth" value="${x.MaxTradesPerMonth}">
                `);
            });
        };

        const escapeHtmlAttr = (s) => String(s ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;');

        const getAssetTargetPoints = () => {
            const table = document.getElementById('tblAssetTargets');
            const tbody = table?.tBodies?.[0];
            if (!tbody) return [];
            return Array.from(tbody.querySelectorAll('tr')).map((r) => {
                const tds = r.querySelectorAll('td');
                return {
                    AssetId: parseIntSafe(tds[0]?.textContent) ?? 0,
                    AssetName: (tds[1]?.textContent || '').trim(),
                    AssetDescription: (tds[2]?.textContent || '').trim(),
                    TargetPointPerTrade: parseIntSafe(tds[3]?.textContent) ?? 0
                };
            }).filter(x => x.AssetId > 0);
        };

        const getPhaseTrades = () => {
            const table = document.getElementById('tblPhaseTrades');
            const tbody = table?.tBodies?.[0];
            if (!tbody) return [];
            return Array.from(tbody.querySelectorAll('tr')).map((r) => {
                const tds = r.querySelectorAll('td');
                return {
                    StrategyNumber: parseIntSafe(tds[0]?.textContent) ?? 0,
                    StrategyDescription: (tds[1]?.textContent || '').trim(),
                    MaxTradesPerDay: parseIntSafe(tds[2]?.textContent) ?? 0,
                    MaxTradesPerWeek: parseIntSafe(tds[3]?.textContent) ?? 0,
                    MaxTradesPerMonth: parseIntSafe(tds[4]?.textContent) ?? 0
                };
            }).filter(x => x.StrategyNumber > 0);
        };

        // Exposed: returns a JS object matching SettingsViewModel
        window.buildSettingsModel = function () {
            const initialCapital = parseDecimalSafe($('input[name="InitialCapital"]')?.value) ?? 0;
            const riskPerTradePercent = Number(String($('input[name="RiskPerTradePercent"]')?.value ?? '0').replace(',', '.'));

            const withdrawl = {
                EstimateWithdrawalPerWeek: parseDecimalSafe($('input[name="Withdrawl.EstimateWithdrawalPerWeek"]')?.value) ?? 0,
                EstimateIncrementWithdrawalPerWeek: parseDecimalSafe($('input[name="Withdrawl.EstimateIncrementWithdrawalPerWeek"]')?.value) ?? 0,
                EstimateWithdrawalPerMonth: parseDecimalSafe($('input[name="Withdrawl.EstimateWithdrawalPerMonth"]')?.value) ?? 0,
                EstimateIncrementWithdrawalPerMonth: parseDecimalSafe($('input[name="Withdrawl.EstimateIncrementWithdrawalPerMonth"]')?.value) ?? 0,
                MaxWithdrawalPerMonth: parseDecimalSafe($('input[name="Withdrawl.MaxWithdrawalPerMonth"]')?.value) ?? 0,
                WithdrawlFrequency: ($('input[name="Withdrawl.WithdrawlFrequency"]')?.value || '').trim()
            };

            return {
                InitialCapital: initialCapital,
                RiskPerTradePercent: Number.isFinite(riskPerTradePercent) ? riskPerTradePercent : 0,
                StrategyPhaseTrade: getPhaseTrades(),
                AssetTargetPoint: getAssetTargetPoints(),
                Withdrawl: withdrawl
            };
        };

        // Modal save: Asset Target
        $('#btnModalSaveAssetTarget')?.addEventListener('click', () => {
            const err = $('#assetTargetError');
            if (err) err.textContent = '';
            const assetId = parseIntSafe($('#assetId')?.value);
            const assetName = ($('#assetName')?.value || '').trim();
            const assetDescription = ($('#assetDescription')?.value || '').trim();
            const points = parseIntSafe($('#targetPointPerTrade')?.value);

            if (!assetId || assetId <= 0) return (err.textContent = 'Invalid #');
            if (!assetName) return (err.textContent = 'Name is required');
            if (points == null || points < 0) return (err.textContent = 'Points is required');

            upsertRow('tblAssetTargets', assetId, [
                { className: 'ts-cell-left', text: String(assetId) },
                { className: 'ts-cell-left', text: assetName },
                { className: 'ts-cell-left', text: assetDescription },
                { className: 'text-grid-center', text: String(points) }
            ]);

            rebuildHiddenInputs();
            modalClose('modalAssetTarget');
        });

        // Modal save: Phase Trade
        $('#btnModalSavePhaseTrade')?.addEventListener('click', () => {
            const err = $('#phaseTradeError');
            if (err) err.textContent = '';
            const strategyNumber = parseIntSafe($('#strategyNumber')?.value);
            const strategyDescription = ($('#strategyDescription')?.value || '').trim();
            const d = parseIntSafe($('#maxTradesPerDay')?.value);
            const w = parseIntSafe($('#maxTradesPerWeek')?.value);
            const m = parseIntSafe($('#maxTradesPerMonth')?.value);

            if (!strategyNumber || strategyNumber <= 0) return (err.textContent = 'Invalid #');
            if (!strategyDescription) return (err.textContent = 'Description is required');
            if (d == null || d < 0 || w == null || w < 0 || m == null || m < 0) return (err.textContent = 'All max fields are required');

            upsertRow('tblPhaseTrades', strategyNumber, [
                { className: 'ts-cell-left', text: String(strategyNumber) },
                { className: 'ts-cell-left', text: strategyDescription },
                { className: 'text-grid-center', text: String(d) },
                { className: 'text-grid-center', text: String(w) },
                { className: 'text-grid-center', text: String(m) }
            ]);

            rebuildHiddenInputs();
            modalClose('modalPhaseTrade');
        });

        // On submit: populate SettingsJson + keep hidden arrays in sync
        $('#settingsForm')?.addEventListener('submit', (e) => {
            rebuildHiddenInputs();
            const model = window.buildSettingsModel();
            $('#SettingsJson').value = JSON.stringify(model);
        });

        // First render: create hidden inputs for existing rows
        rebuildHiddenInputs();
    })();</script>